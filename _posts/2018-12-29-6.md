---
layout: post_layout
title: brpc之iobuf 
time: 2018年12月29日 星期六
location: 深圳
pulished: true
excerpt_separator: "brpc iobuf"
---

---
brpc iobuf类学习，官方文档：[https://github.com/brpc/brpc/blob/master/docs/cn/iobuf.md](https://github.com/brpc/brpc/blob/master/docs/cn/iobuf.md)

    如果文章有任何冒犯之处，如侵权或者未标明引用，请邮件联系删除

iobuf是一种非连续零拷贝缓冲数据结构，具体用法可以参考上面的官方链接，本文主要介绍一下其中的组成类和一些实现方法

# 1. iobuf以及类构成

# 2. iobuf内存结构
从数据结构上来看，iobuf包含了一个BigView和SmallView的联合体；[匿名联合体](https://zh.cppreference.com/w/cpp/language/union)

```c++
class IOBuf {
    struct SmallView { BlockRef refs[2]; };

    struct BigView {
        int32_t magic;
        uint32_t start;
        BlockRef* refs;
        uint32_t nref;
        uint32_t cap_mask;
        size_t nbytes;

        const BlockRef& ref_at(uint32_t i) const
        { return refs[(start + i) & cap_mask]; }
        
        BlockRef& ref_at(uint32_t i)
        { return refs[(start + i) & cap_mask]; }

        uint32_t capacity() const { return cap_mask + 1; }
    };

private:    
    union { //联合体
        BigView _bv;
        SmallView _sv;
    };
};
```



c++ 的memory order可以参考这里 [http://senlinzhan.github.io/2017/12/04/cpp-memory-order/](http://senlinzhan.github.io/2017/12/04/cpp-memory-order/)


# 3. iobuf常用操作

